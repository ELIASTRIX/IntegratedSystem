<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mystic University - Unified System</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400..800;1,400..800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

    <!-- SheetJS (xlsx) library for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- Custom Styles -->
    <style>
        :root {
            --bs-body-font-family: 'Sarabun', sans-serif;
            --theme-color-primary: #ffc107; /* Default Gold */
            --theme-color-secondary: #0c1427; /* Default Dark Blue */
        }
        body {
            background-color: #0c1427;
            background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
            color: #FFFFFF; 
            margin: 0;
        }
        .font-mystic { font-family: 'EB Garamond', serif; }
        .card {
            background-color: rgba(23, 37, 84, 0.88);
            border: 1px solid rgba(253, 224, 71, 0.2);
            backdrop-filter: blur(8px);
        }
        .btn-theme {
             background-color: var(--theme-color-primary);
             color: var(--theme-color-secondary);
             border: 1px solid var(--theme-color-primary);
        }
        .btn-theme:hover { opacity: 0.9; }
        .btn-outline-theme {
             color: var(--theme-color-primary);
             border-color: var(--theme-color-primary);
        }
        .btn-outline-theme:hover {
            background-color: var(--theme-color-primary);
            color: var(--theme-color-secondary);
        }
        .modal-backdrop-custom {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        #modal-body, .form-label, .user-list-name, .list-item-title, .nav-link, h1, h2, h3, h4, h5, h6, p, label, .form-check-label { color: #FFFFFF; }
        .user-list-email, .list-item-subtitle, .dashboard-header-subtext, .status-meta { color: #FFFFFF; opacity: 0.8; }
        .nav-link.active {
            background-color: var(--theme-color-primary) !important;
            color: var(--theme-color-secondary) !important;
        }
        .nav-link:not(.active):hover { color: var(--theme-color-primary) !important; }
        .profile-pic, .sidebar-profile-pic {
            width: 80px; height: 80px; object-fit: cover; border-radius: 50%;
            border: 2px solid var(--theme-color-primary);
        }
        .sidebar-profile-pic { width: 60px; height: 60px; }
        .theme-text, .text-warning { color: var(--theme-color-primary) !important; }
        .form-control, .form-select {
            background-color: #1a2541 !important;
            color: #FFFFFF !important; 
            border-color: #4a5568 !important;
        }
        .form-control::placeholder { color: #a0aec0 !important; }
        .accordion-button { background-color: rgba(255, 255, 255, 0.05); color: #FFFFFF; }
        .accordion-button:not(.collapsed) { background-color: var(--theme-color-primary); color: var(--theme-color-secondary); }
        .accordion-button:focus { box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.25); }
        .accordion-body { background-color: rgba(0,0,0,0.2); }
        .accordion-item { background-color: transparent; border: 1px solid rgba(255, 255, 255, 0.1); }
        .question-item { cursor: grab; }
        .sortable-ghost { opacity: 0.4; background: #2d3748; }
        .btn-discord {
            background-color: #5865F2;
            border-color: #5865F2;
        }
        .btn-discord:hover {
            background-color: #4f5bda;
            border-color: #4f5bda;
        }
    </style>
</head>
<body class="min-vh-100">

    <!-- Root container for views -->
    <div id="root">
        <div class="min-vh-100 d-flex align-items-center justify-content-center">
             <div class="text-center">
                <div class="spinner-border text-warning" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 fs-5">กำลังร่ายเวทเชื่อมต่อ...</p>
            </div>
        </div>
    </div>

    <!-- Modal containers -->
    <div id="modal-container"></div>
    <div id="student-list-modal-container"></div>
    <div id="view-application-modal-container"></div>


    <!-- =============================================================================== -->
    <!-- HTML TEMPLATES -->
    <!-- =============================================================================== -->

    <template id="template-login">
        <div class="min-vh-100 d-flex align-items-center justify-content-center p-4">
            <div class="w-100" style="max-width: 450px;">
                 <div class="card rounded-4 p-5 text-center">
                    <img src="https://i.imgur.com/gO9aY0g.png" alt="Mystic University Logo" class="mx-auto mb-4" style="width: 120px; height: auto;">
                    <h1 class="font-mystic text-white mt-3" style="font-size: 2.5rem;">Mystic University</h1>
                    <p class="text-white-50 mb-5">ยินดีต้อนรับสู่ประตูมิติแห่งการศึกษา</p>
                    <button id="discord-login-btn" class="btn btn-discord w-100 py-3 fs-5 fw-bold">
                        <i class="fab fa-discord me-2"></i> เข้าสู่ระบบด้วย Discord
                    </button>
                    <div id="login-status" class="mt-4 text-warning-emphasis"></div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-application">
        <div class="min-vh-100 d-flex align-items-center justify-content-center p-4">
             <div class="w-100" style="max-width: 600px;">
                 <div class="card rounded-4 p-5">
                    <h2 class="font-mystic text-white mb-2 text-center" style="font-size: 2rem;">กรอกใบสมัคร</h2>
                    <p class="text-center text-white-50 mb-4">คุณเป็นนักศึกษาใหม่! กรุณากรอกใบสมัครเพื่อดำเนินการต่อ</p>
                    <form id="application-form" class="row g-4">
                        <div id="application-questions-container" class="col-12 row g-4">
                            <p class="text-center text-white-50">กำลังโหลดคำถามในใบสมัคร...</p>
                        </div>
                        <div class="col-12 pt-4">
                           <button type="submit" class="btn btn-warning w-100 py-2 fs-5 fw-bold">ส่งใบสมัคร</button>
                        </div>
                    </form>
                    <div class="text-center mt-3">
                        <button id="logout-from-apply-btn" class="btn btn-sm btn-outline-danger">ยกเลิกและออกจากระบบ</button>
                    </div>
                 </div>
            </div>
        </div>
    </template>

    <template id="template-main">
        <div class="d-flex vh-100">
            <nav id="sidebar" class="d-flex flex-column p-4" style="width: 280px; background-color: #040814;"></nav>
            <main id="main-content-area" class="flex-grow-1 p-4 overflow-auto" style="background-color: #0c1427;"></main>
        </div>
    </template>
    
    <!-- Other Templates (admin-dashboard, admin-manage-users, etc.) remain the same -->
    <template id="template-admin-dashboard"><!-- ... --></template>
    <template id="template-admin-manage-users"><!-- ... --></template>
    <template id="template-admin-manage-application"><!-- ... --></template>
    <template id="template-user-profile"><!-- ... --></template>
    <template id="template-professor-manage-classes"><!-- ... --></template>
    <template id="template-student-dashboard"><!-- ... --></template>

    <!-- =================================================================== -->
    <!-- Firebase SDK & Application Logic                                    -->
    <!-- =================================================================== -->
    <script type="module">
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithPopup, OAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, onSnapshot, serverTimestamp, updateDoc, addDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBjwdiWQSr79kC3pkfg0bVVqJEIIOdGKZk",
          authDomain: "mysticuniversity-new.firebaseapp.com",
          projectId: "mysticuniversity-new",
          storageBucket: "mysticuniversity-new.appspot.com",
          messagingSenderId: "497832675763",
          appId: "1:497832675763:web:9ccb68900bc9b4415163c6"
        };
        
        const CONSTANTS = { /* ... Same constants as before ... */ };

        class MysticUniversityApp {
            constructor(config, constants) {
                this.app = getApps().length === 0 ? initializeApp(config) : getApp();
                this.auth = getAuth(this.app);
                this.db = getFirestore(this.app);
                this.constants = constants;
                this.currentUserData = null; 
                this.unsubscribeListeners = [];
                this.sortableInstance = null;
                this.root = document.getElementById('root');
                this.init();
            }

            init() {
                this.initializeAuthListener();
            }

            initializeAuthListener() {
                onAuthStateChanged(this.auth, async (user) => {
                    this.cleanupListeners(); 
                    if (user) {
                        const userDocRef = this.userDocRef(user.uid);
                        const userDocSnap = await getDoc(userDocRef);

                        if (userDocSnap.exists()) {
                            // Returning user
                            this.currentUserData = { uid: user.uid, ...userDocSnap.data() };
                            if (this.currentUserData.status === 'active') {
                                this.renderView('main');
                            } else {
                                await signOut(this.auth);
                                this.renderView('login', { message: `สถานะบัญชีของคุณคือ '${this.currentUserData.status}'. กรุณารอการอนุมัติ` });
                            }
                        } else {
                            // New user, needs to apply
                            this.renderView('application', { discordUser: user });
                        }
                    } else {
                        // User is signed out
                        this.currentUserData = null;
                        this.renderView('login');
                    }
                });
            }

            renderView(viewName, params = {}) {
                this.cleanupListeners();
                const template = document.getElementById(`template-${viewName}`);
                if (template) {
                    this.root.innerHTML = '';
                    const content = template.content.cloneNode(true);
                    this.root.appendChild(content);
                    this.setupView(viewName, params);
                } else {
                    console.error(`View template not found: ${viewName}`);
                    this.root.innerHTML = `<p class="text-danger text-center p-5">Error: View "${viewName}" not found.</p>`;
                }
            }
            
            setupView(viewName, params) {
                switch (viewName) {
                    case 'login': this.setupLoginPage(params.message); break;
                    case 'application': this.setupApplicationPage(params.discordUser); break;
                    case 'main': this.setupMainApp(); break;
                }
            }
            
            setupLoginPage(message = '') {
                const loginBtn = document.getElementById('discord-login-btn');
                const loginStatus = document.getElementById('login-status');
                if (message) {
                    loginStatus.textContent = message;
                }
                loginBtn.addEventListener('click', async () => {
                    loginStatus.textContent = 'กำลังเชื่อมต่อกับ Discord...';
                    const provider = new OAuthProvider('discord.com');
                    try {
                        await signInWithPopup(this.auth, provider);
                        // onAuthStateChanged will handle the rest
                    } catch (error) {
                        console.error("Discord login failed:", error);
                        loginStatus.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
                    }
                });
            }

            async setupApplicationPage(discordUser) {
                if (!discordUser) {
                    this.renderView('login', { message: 'เกิดข้อผิดพลาด โปรดลองเข้าสู่ระบบอีกครั้ง' });
                    return;
                }

                document.getElementById('logout-from-apply-btn').onclick = () => signOut(this.auth);
                
                const questionsContainer = document.getElementById('application-questions-container');
                questionsContainer.innerHTML = '';
                const q = query(this.appFormCollectionRef(), orderBy("createdAt", "asc"));
                const questionsSnapshot = await getDocs(q);
                
                if (questionsSnapshot.empty) {
                    questionsContainer.innerHTML = '<p class="text-white-50">ขออภัย, ขณะนี้ระบบปิดรับใบสมัคร</p>';
                    document.querySelector('#application-form button[type="submit"]').disabled = true;
                    return;
                }
                
                questionsSnapshot.forEach(docSnap => {
                    const qData = { id: docSnap.id, ...docSnap.data() };
                    const div = document.createElement('div');
                    div.className = 'col-12';
                    // ... (Code to build input fields based on qData, same as previous version)
                    let inputHtml = '';
                    const requiredAttr = qData.required ? 'required' : '';
                    switch(qData.type) {
                        case 'textarea': inputHtml = `<textarea name="${qData.id}" class="form-control" rows="3" ${requiredAttr}></textarea>`; break;
                        case 'number': inputHtml = `<input type="number" name="${qData.id}" class="form-control" ${requiredAttr}>`; break;
                        case 'select':
                            const optionsHtml = qData.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                            inputHtml = `<select name="${qData.id}" class="form-select" ${requiredAttr}><option value="">-- เลือก --</option>${optionsHtml}</select>`;
                            break;
                        default: inputHtml = `<input type="text" name="${qData.id}" class="form-control" ${requiredAttr}>`;
                    }
                    div.innerHTML = `<label for="${qData.id}" class="form-label">${qData.label} ${qData.required ? '<span class="text-danger">*</span>' : ''}</label>${inputHtml}`;
                    questionsContainer.appendChild(div);
                });

                document.getElementById('application-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const applicationAnswers = {};
                    const formElements = e.target.elements;
                    questionsSnapshot.forEach(docSnap => {
                        const qData = { id: docSnap.id, ...docSnap.data() };
                        if (formElements[qData.id]) {
                            applicationAnswers[qData.label] = formElements[qData.id].value;
                        }
                    });

                    const characterName = applicationAnswers[CONSTANTS.CHARACTER_NAME_QUESTION_LABEL];
                    if (!characterName) {
                        alert(`เกิดข้อผิดพลาด: ไม่พบคำตอบสำหรับคำถาม "${CONSTANTS.CHARACTER_NAME_QUESTION_LABEL}" ซึ่งจำเป็นสำหรับการตั้งชื่อตัวละคร กรุณาติดต่อผู้ดูแล`);
                        return;
                    }

                    try {
                        await setDoc(this.userDocRef(discordUser.uid), {
                            name: characterName,
                            email: discordUser.email,
                            discordUsername: discordUser.displayName,
                            photoURL: discordUser.photoURL,
                            house: null,
                            role: 'student',
                            year: 1,
                            status: 'pending',
                            scores: {},
                            applicationAnswers: applicationAnswers,
                            createdAt: serverTimestamp()
                        });

                        await signOut(this.auth);
                        // The onAuthStateChanged listener will automatically redirect to the login page
                        // with the pending status message after the next login attempt.
                        alert('ส่งใบสมัครสำเร็จ! กรุณารอการอนุมัติจากผู้ดูแลระบบ');
                    } catch (error) {
                        console.error("Application submission failed:", error);
                        alert(`เกิดข้อผิดพลาดในการส่งใบสมัคร: ${error.message}`);
                    }
                });
            }
            
            // ... All other methods remain largely the same ...
        }

        window.app = new MysticUniversityApp(firebaseConfig, CONSTANTS);
    </script>
</body>
</html>
