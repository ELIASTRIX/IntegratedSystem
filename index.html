<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mystic University - Unified System</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400..800;1,400..800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

    <!-- SheetJS (xlsx) library for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- Custom Styles -->
    <style>
        :root {
            --bs-body-font-family: 'Sarabun', sans-serif;
            --theme-color-primary: #ffc107; /* Default Gold */
            --theme-color-secondary: #0c1427; /* Default Dark Blue */
        }
        body {
            background-color: #0c1427;
            background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
            color: #FFFFFF; 
            margin: 0;
        }
        .font-mystic { font-family: 'EB Garamond', serif; }
        .card {
            background-color: rgba(23, 37, 84, 0.88);
            border: 1px solid rgba(253, 224, 71, 0.2);
            backdrop-filter: blur(8px);
        }
        .btn-theme {
             background-color: var(--theme-color-primary);
             color: var(--theme-color-secondary);
             border: 1px solid var(--theme-color-primary);
        }
        .btn-theme:hover { opacity: 0.9; }
        .btn-outline-theme {
             color: var(--theme-color-primary);
             border-color: var(--theme-color-primary);
        }
        .btn-outline-theme:hover {
            background-color: var(--theme-color-primary);
            color: var(--theme-color-secondary);
        }
        .modal-backdrop-custom {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        .modal-dialog {
             max-width: 500px;
        }
        #modal-body, .form-label, .user-list-name, .list-item-title, .nav-link, h1, h2, h3, h4, h5, h6, p, label, .form-check-label { color: #FFFFFF; }
        .user-list-email, .list-item-subtitle, .dashboard-header-subtext, .status-meta { color: #FFFFFF; opacity: 0.8; }
        .nav-link.active {
            background-color: var(--theme-color-primary) !important;
            color: var(--theme-color-secondary) !important;
        }
        .nav-link:not(.active):hover { color: var(--theme-color-primary) !important; }
        .profile-pic, .sidebar-profile-pic {
            width: 80px; height: 80px; object-fit: cover; border-radius: 50%;
            border: 2px solid var(--theme-color-primary);
        }
        .sidebar-profile-pic { width: 60px; height: 60px; }
        .theme-text, .text-warning { color: var(--theme-color-primary) !important; }
        .form-control, .form-select {
            background-color: #1a2541 !important;
            color: #FFFFFF !important; 
            border-color: #4a5568 !important;
        }
        .form-control::placeholder { color: #a0aec0 !important; }
        .accordion-button { background-color: rgba(255, 255, 255, 0.05); color: #FFFFFF; }
        .accordion-button:not(.collapsed) { background-color: var(--theme-color-primary); color: var(--theme-color-secondary); }
        .accordion-button:focus { box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.25); }
        .accordion-body { background-color: rgba(0,0,0,0.2); }
        .accordion-item { background-color: transparent; border: 1px solid rgba(255, 255, 255, 0.1); }
        .question-item { cursor: grab; }
        .sortable-ghost { opacity: 0.4; background: #2d3748; }
        .btn-discord {
            background-color: #5865F2;
            border-color: #5865F2;
        }
        .btn-discord:hover {
            background-color: #4f5bda;
            border-color: #4f5bda;
        }
    </style>
</head>
<body class="min-vh-100">

    <!-- Root container for views -->
    <div id="root">
        <div class="min-vh-100 d-flex align-items-center justify-content-center">
             <div class="text-center">
                <div class="spinner-border text-warning" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 fs-5">กำลังร่ายเวทเชื่อมต่อ...</p>
            </div>
        </div>
    </div>

    <!-- Main Modal -->
    <div class="modal fade" id="mainModal" tabindex="-1" aria-labelledby="mainModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content card">
                <div class="modal-header border-0">
                    <h5 class="modal-title font-mystic text-warning" id="mainModalLabel"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="mainModalBody">
                    <!-- Modal content goes here -->
                </div>
                <div class="modal-footer border-0" id="mainModalFooter">
                    <!-- Modal buttons go here -->
                </div>
            </div>
        </div>
    </div>


    <!-- =============================================================================== -->
    <!-- HTML TEMPLATES -->
    <!-- =============================================================================== -->

    <template id="template-login">
        <div class="min-vh-100 d-flex align-items-center justify-content-center p-4">
            <div class="w-100" style="max-width: 450px;">
                 <div class="card rounded-4 p-5 text-center">
                    <img src="https://i.imgur.com/gO9aY0g.png" alt="Mystic University Logo" class="mx-auto mb-4" style="width: 120px; height: auto;">
                    <h1 class="font-mystic text-white mt-3" style="font-size: 2.5rem;">Mystic University</h1>
                    <p class="text-white-50 mb-5">ยินดีต้อนรับสู่ประตูมิติแห่งการศึกษา</p>
                    <button id="discord-login-btn" class="btn btn-discord w-100 py-3 fs-5 fw-bold">
                        <i class="fab fa-discord me-2"></i> เข้าสู่ระบบด้วย Discord
                    </button>
                    <div id="login-status" class="mt-4 text-warning-emphasis"></div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-application">
        <div class="min-vh-100 d-flex align-items-center justify-content-center p-4">
             <div class="w-100" style="max-width: 600px;">
                 <div class="card rounded-4 p-5">
                    <h2 class="font-mystic text-white mb-2 text-center" style="font-size: 2rem;">กรอกใบสมัคร</h2>
                    <p class="text-center text-white-50 mb-4">คุณเป็นนักศึกษาใหม่! กรุณากรอกใบสมัครเพื่อดำเนินการต่อ</p>
                    <form id="application-form" class="row g-4">
                        <div id="application-questions-container" class="col-12 row g-4">
                            <p class="text-center text-white-50">กำลังโหลดคำถามในใบสมัคร...</p>
                        </div>
                        <div class="col-12 pt-4">
                           <button type="submit" class="btn btn-warning w-100 py-2 fs-5 fw-bold">ส่งใบสมัคร</button>
                        </div>
                    </form>
                    <div class="text-center mt-3">
                        <button id="logout-from-apply-btn" class="btn btn-sm btn-outline-danger">ยกเลิกและออกจากระบบ</button>
                    </div>
                 </div>
            </div>
        </div>
    </template>

    <template id="template-main">
        <div class="d-flex vh-100">
            <nav id="sidebar" class="d-flex flex-column p-4" style="width: 280px; background-color: #040814;"></nav>
            <main id="main-content-area" class="flex-grow-1 p-4 overflow-auto" style="background-color: #0c1427;"></main>
        </div>
    </template>
    
    <template id="template-admin-dashboard">
        <h2 class="font-mystic text-warning mb-4 fs-2">ภาพรวมสภา</h2>
        <div class="row g-4">
            <div class="col-12">
                <div class="card p-4 rounded-3 h-100 mb-4">
                    <h3 class="fs-5 fw-bold mb-3">คำร้องขอเข้าศึกษาที่รออนุมัติ</h3>
                    <div id="pending-students-list" class="vstack gap-3"></div>
                </div>
                <div class="card p-4 rounded-3 h-100 mb-4">
                    <h3 class="fs-5 fw-bold mb-3">คำขอเลื่อนชั้นปี</h3>
                    <div id="promotion-requests-list" class="vstack gap-3"></div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-admin-manage-users">
        <h2 class="font-mystic text-warning mb-4 fs-2">บริหารจัดการผู้ใช้</h2>
        <div class="row g-4">
            <div class="col-md-5">
                <div class="card p-4 rounded-3 h-100">
                   <h3 class="fs-5 fw-bold mb-3">ลงทะเบียนศาสตราจารย์</h3>
                   <form id="create-professor-form" class="vstack gap-3">
                       <!-- This part is intentionally left out as it uses email/password. Could be re-implemented if needed. -->
                       <p class="text-white-50">การสร้างศาสตราจารย์โดยตรงถูกปิดใช้งานในโหมด Discord-Only</p>
                   </form>
               </div>
           </div>
           <div class="col-md-7">
               <div class="card p-4 rounded-3 h-100">
                   <h3 class="fs-5 fw-bold mb-3">รายชื่อผู้ใช้ทั้งหมด</h3>
                   <div id="all-users-container"></div>
               </div>
           </div>
       </div>
    </template>

    <template id="template-admin-manage-application">
        <h2 class="font-mystic text-warning mb-4 fs-2">จัดการแบบฟอร์มใบสมัคร</h2>
        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card p-4 rounded-3 h-100">
                    <h3 class="fs-5 fw-bold mb-3">คำถามในฟอร์มปัจจุบัน</h3>
                    <div id="question-list" class="vstack gap-2"></div>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="card p-4 rounded-3">
                    <h3 class="fs-5 fw-bold mb-3">เพิ่มคำถามใหม่</h3>
                    <form id="add-question-form" class="vstack gap-3">
                        <div>
                            <label for="q-label" class="form-label">คำถาม/หัวข้อ</label>
                            <input type="text" id="q-label" class="form-control" required>
                        </div>
                        <div>
                            <label for="q-type" class="form-label">ประเภท</label>
                            <select id="q-type" class="form-select">
                                <option value="text">คำตอบสั้น</option>
                                <option value="textarea">คำตอบยาว</option>
                                <option value="number">ตัวเลข</option>
                                <option value="select">ตัวเลือกเดียว (Dropdown)</option>
                            </select>
                        </div>
                        <div id="q-options-container" class="d-none">
                            <label for="q-options" class="form-label">ตัวเลือก (1 บรรทัดต่อ 1 ตัวเลือก)</label>
                            <textarea id="q-options" rows="3" class="form-control"></textarea>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="q-required">
                            <label class="form-check-label" for="q-required">จำเป็นต้องตอบ</label>
                        </div>
                        <div class="pt-2">
                           <button type="submit" class="btn btn-warning w-100 fw-bold">เพิ่มคำถาม</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-student-dashboard">
         <div id="student-dashboard-header" class="d-flex align-items-center mb-4 p-3 rounded-3">
            <img id="student-house-logo" src="" alt="House Logo" style="width: 80px; height: auto; margin-right: 20px;">
            <div>
                <h2 class="font-mystic dashboard-header-text mb-0 fs-2">Dashboard นักศึกษา</h2>
                <h3 id="student-house-name" class="fs-5 dashboard-header-subtext"></h3>
            </div>
        </div>
        <!-- Rest of student dashboard -->
    </template>

    <!-- =================================================================== -->
    <!-- Firebase SDK & Application Logic                                    -->
    <!-- =================================================================== -->
    <script type="module">
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithPopup, OAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, onSnapshot, serverTimestamp, updateDoc, addDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBjwdiWQSr79kC3pkfg0bVVqJEIIOdGKZk",
          authDomain: "mysticuniversity-new.firebaseapp.com",
          projectId: "mysticuniversity-new",
          storageBucket: "mysticuniversity-new.appspot.com",
          messagingSenderId: "497832675763",
          appId: "1:497832675763:web:9ccb68900bc9b4415163c6"
        };
        
        const CONSTANTS = { 
            CHARACTER_NAME_QUESTION_LABEL: 'ชื่อตัวละคร (ในเกม)',
            HOUSES: {
                 "Phoenix": { logo: "https://i.imgur.com/8z3v8sP.png", primaryColor: "#D32F2F", secondaryColor: "#FFFFFF" },
                 "Liger": { logo: "https://i.imgur.com/i4a17mC.png", primaryColor: "#FFC107", secondaryColor: "#000000" },
                 "Colossal Kraken": { logo: "https://i.imgur.com/K1xAf1u.png", primaryColor: "#1976D2", secondaryColor: "#FFFFFF" },
                 "King Ghidorah": { logo: "https://i.imgur.com/1CqD2Q5.png", primaryColor: "#388E3C", secondaryColor: "#FFFFFF" }
            },
            SUBJECTS: {} // Add subjects if needed
        };

        class MysticUniversityApp {
            constructor(config, constants) {
                this.app = getApps().length === 0 ? initializeApp(config) : getApp();
                this.auth = getAuth(this.app);
                this.db = getFirestore(this.app);
                this.constants = constants;
                this.currentUserData = null; 
                this.unsubscribeListeners = [];
                this.sortableInstance = null;
                this.root = document.getElementById('root');
                this.modalInstance = null;
                this.init();
            }

            // --- Path Helpers ---
            userDocRef = (uid) => doc(this.db, "users", uid);
            usersCollectionRef = () => collection(this.db, "users");
            appFormCollectionRef = () => collection(this.db, "applicationForms");

            init() {
                this.initializeAuthListener();
                const mainModalEl = document.getElementById('mainModal');
                if (mainModalEl) {
                     this.modalInstance = new bootstrap.Modal(mainModalEl);
                }
            }

            cleanupListeners() {
                this.unsubscribeListeners.forEach(unsub => unsub());
                this.unsubscribeListeners = [];
                if (this.sortableInstance) {
                    this.sortableInstance.destroy();
                    this.sortableInstance = null;
                }
            }
            
            initializeAuthListener() {
                onAuthStateChanged(this.auth, async (user) => {
                    this.cleanupListeners(); 
                    if (user) {
                        const userDocRef = this.userDocRef(user.uid);
                        const userDocSnap = await getDoc(userDocRef);

                        if (userDocSnap.exists()) {
                            // Returning user
                            this.currentUserData = { uid: user.uid, ...userDocSnap.data() };
                            if (this.currentUserData.status === 'active') {
                                this.renderView('main');
                            } else {
                                await signOut(this.auth);
                                this.renderView('login', { message: `สถานะบัญชีของคุณคือ '${this.currentUserData.status}'. กรุณารอการอนุมัติ` });
                            }
                        } else {
                            // New user, needs to apply
                            this.renderView('application', { discordUser: user });
                        }
                    } else {
                        // User is signed out
                        this.currentUserData = null;
                        this.renderView('login');
                    }
                });
            }

            renderView(viewName, params = {}) {
                this.cleanupListeners();
                const template = document.getElementById(`template-${viewName}`);
                if (template) {
                    this.root.innerHTML = '';
                    const content = template.content.cloneNode(true);
                    this.root.appendChild(content);
                    this.setupView(viewName, params);
                } else {
                    console.error(`View template not found: ${viewName}`);
                    this.root.innerHTML = `<p class="text-danger text-center p-5">Error: View "${viewName}" not found.</p>`;
                }
            }
            
            setupView(viewName, params) {
                switch (viewName) {
                    case 'login': this.setupLoginPage(params.message); break;
                    case 'application': this.setupApplicationPage(params.discordUser); break;
                    case 'main': this.setupMainApp(); break;
                }
            }

            showModal(title, body, footer = '') {
                if (!this.modalInstance) return;
                document.getElementById('mainModalLabel').innerHTML = title;
                document.getElementById('mainModalBody').innerHTML = body;
                document.getElementById('mainModalFooter').innerHTML = footer;
                this.modalInstance.show();
            }

            escapeHtml(unsafe) {
                if (typeof unsafe !== 'string') return '';
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
            
            setupLoginPage(message = '') {
                const loginBtn = document.getElementById('discord-login-btn');
                const loginStatus = document.getElementById('login-status');
                if (message) {
                    loginStatus.textContent = message;
                }
                loginBtn.addEventListener('click', async () => {
                    loginStatus.textContent = 'กำลังเชื่อมต่อกับ Discord...';
                    const provider = new OAuthProvider('discord.com');
                    try {
                        await signInWithPopup(this.auth, provider);
                    } catch (error) {
                        console.error("Discord login failed:", error);
                        loginStatus.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
                    }
                });
            }

            async setupApplicationPage(discordUser) {
                if (!discordUser) {
                    this.renderView('login', { message: 'เกิดข้อผิดพลาด โปรดลองเข้าสู่ระบบอีกครั้ง' });
                    return;
                }

                document.getElementById('logout-from-apply-btn').onclick = () => signOut(this.auth);
                
                const questionsContainer = document.getElementById('application-questions-container');
                questionsContainer.innerHTML = '';
                const q = query(this.appFormCollectionRef(), orderBy("createdAt", "asc"));
                const questionsSnapshot = await getDocs(q);
                
                if (questionsSnapshot.empty) {
                    questionsContainer.innerHTML = '<p class="text-white-50">ขออภัย, ขณะนี้ระบบปิดรับใบสมัคร</p>';
                    document.querySelector('#application-form button[type="submit"]').disabled = true;
                    return;
                }
                
                questionsSnapshot.forEach(docSnap => {
                    const qData = { id: docSnap.id, ...docSnap.data() };
                    const div = document.createElement('div');
                    div.className = 'col-12';
                    let inputHtml = '';
                    const requiredAttr = qData.required ? 'required' : '';
                    switch(qData.type) {
                        case 'textarea': inputHtml = `<textarea name="${qData.id}" class="form-control" rows="3" ${requiredAttr}></textarea>`; break;
                        case 'number': inputHtml = `<input type="number" name="${qData.id}" class="form-control" ${requiredAttr}>`; break;
                        case 'select':
                            const optionsHtml = qData.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                            inputHtml = `<select name="${qData.id}" class="form-select" ${requiredAttr}><option value="">-- เลือก --</option>${optionsHtml}</select>`;
                            break;
                        default: inputHtml = `<input type="text" name="${qData.id}" class="form-control" ${requiredAttr}>`;
                    }
                    div.innerHTML = `<label for="${qData.id}" class="form-label">${qData.label} ${qData.required ? '<span class="text-danger">*</span>' : ''}</label>${inputHtml}`;
                    questionsContainer.appendChild(div);
                });

                document.getElementById('application-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const applicationAnswers = {};
                    const formElements = e.target.elements;
                    questionsSnapshot.forEach(docSnap => {
                        const qData = { id: docSnap.id, ...docSnap.data() };
                        if (formElements[qData.id]) {
                            applicationAnswers[qData.label] = formElements[qData.id].value;
                        }
                    });

                    const characterName = applicationAnswers[CONSTANTS.CHARACTER_NAME_QUESTION_LABEL];
                    if (!characterName) {
                        alert(`เกิดข้อผิดพลาด: ไม่พบคำตอบสำหรับคำถาม "${CONSTANTS.CHARACTER_NAME_QUESTION_LABEL}" ซึ่งจำเป็นสำหรับการตั้งชื่อตัวละคร กรุณาติดต่อผู้ดูแล`);
                        return;
                    }

                    try {
                        await setDoc(this.userDocRef(discordUser.uid), {
                            name: characterName,
                            email: discordUser.email,
                            discordUsername: discordUser.displayName,
                            photoURL: discordUser.photoURL,
                            house: null,
                            role: 'student',
                            year: 1,
                            status: 'pending',
                            scores: {},
                            applicationAnswers: applicationAnswers,
                            createdAt: serverTimestamp()
                        });

                        alert('ส่งใบสมัครสำเร็จ! กรุณารอการอนุมัติจากผู้ดูแลระบบ');
                        await signOut(this.auth);
                    } catch (error) {
                        console.error("Application submission failed:", error);
                        alert(`เกิดข้อผิดพลาดในการส่งใบสมัคร: ${error.message}`);
                    }
                });
            }
            
            setupMainApp() {
                const sidebar = document.getElementById('sidebar');
                sidebar.innerHTML = `
                    <div class="text-center mb-5">
                         <h1 class="fs-4 font-mystic">Mystic University</h1>
                    </div>
                    <div id="nav-links" class="nav nav-pills flex-column mb-auto"></div>
                    <div id="user-profile-summary" class="mt-auto text-center border-top border-secondary pt-3"></div>
                    <button id="logout-button" class="btn btn-outline-warning w-100 mt-3">ออกจากระบบ</button>
                `;
                document.getElementById('logout-button').addEventListener('click', () => signOut(this.auth));
                this.applyUserTheme();
                this.renderProfileSummary();
                this.renderNavLinks();
                if(document.querySelector('#nav-links .nav-link')) {
                    document.querySelector('#nav-links .nav-link').click();
                }
            }

            applyUserTheme() {
                // ... logic to apply theme based on house/subject
            }
            
            renderProfileSummary() {
                 const container = document.getElementById('user-profile-summary');
                 if(!container || !this.currentUserData) return;
                 container.innerHTML = `
                    <img src="${this.currentUserData.photoURL || 'https://placehold.co/80x80/040814/e0e0e0?text=User'}" alt="Profile Picture" class="sidebar-profile-pic mx-auto mb-2">
                    <p class="fw-bold">${this.escapeHtml(this.currentUserData.name)}</p>
                    <p class="small theme-text mb-0">${this.currentUserData.role}</p>
                `;
            }

            renderNavLinks() {
                const container = document.getElementById('nav-links');
                if (!container) return;
                container.innerHTML = '';
                
                let links = [];
                const { role } = this.currentUserData;

                if (role === 'admin') {
                    links = [ 
                        { name: 'ภาพรวมสภา', page: 'admin-dashboard' },
                        { name: 'บริหารจัดการผู้ใช้', page: 'admin-manage-users' },
                        { name: 'จัดการใบสมัคร', page: 'admin-manage-application' },
                    ];
                } else if (role === 'professor') {
                    // Professor links
                } else if (role === 'student') {
                    links = [
                        { name: 'Dashboard', page: 'student-dashboard'}, 
                    ];
                }
                
                links.forEach((link, index) => {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.className = `nav-link d-flex align-items-center gap-2 ${index === 0 ? 'active' : ''}`;
                    a.innerHTML = `<span>${link.name}</span>`;
                    
                    a.onclick = (e) => {
                        e.preventDefault();
                        document.querySelectorAll('#nav-links .nav-link').forEach(l => l.classList.remove('active'));
                        a.classList.add('active');
                        this.loadPageContent(link.page);
                    };
                    container.appendChild(a);
                });
                
                if (links.length > 0) {
                    this.loadPageContent(links[0].page);
                }
            }
            
            loadPageContent(pageName) {
                this.cleanupListeners();
                const mainContentArea = document.getElementById('main-content-area');
                const template = document.getElementById(`template-${pageName}`);
                
                if (template) {
                    mainContentArea.innerHTML = '';
                    mainContentArea.appendChild(template.content.cloneNode(true));
                    
                    switch(pageName) {
                        case 'admin-dashboard': this.loadAdminDashboard(); break;
                        case 'admin-manage-users': this.loadAdminManageUsers(); break;
                        case 'admin-manage-application': this.loadAdminManageApplication(); break;
                        case 'student-dashboard': this.loadStudentDashboard(); break;
                    }
                } else {
                    mainContentArea.innerHTML = `<p class="text-danger">Content for "${pageName}" not found.</p>`;
                }
            }
            
            loadAdminDashboard() {
                 const pendingList = document.getElementById('pending-students-list');
                 const qPending = query(this.usersCollectionRef(), where("status", "==", "pending"));
                 const unsubPending = onSnapshot(qPending, (snapshot) => {
                     pendingList.innerHTML = '';
                     if(snapshot.empty) {
                         pendingList.innerHTML = '<p class="text-white-50">ไม่มีคำร้องขอในขณะนี้</p>';
                         return;
                     }
                     snapshot.forEach((docSnap) => {
                         const student = { id: docSnap.id, ...docSnap.data() };
                         const item = document.createElement('div');
                         item.className = 'd-flex align-items-center justify-content-between p-2 rounded';
                         item.style.backgroundColor = 'rgba(0,0,0,0.2)';
                         item.innerHTML = `
                             <div>
                                 <p class="fw-bold mb-0">${this.escapeHtml(student.name)}</p>
                                 <p class="small text-white-50 mb-0">${this.escapeHtml(student.email)}</p>
                             </div>
                             <div class="d-flex gap-2">
                                 <button class="btn btn-sm btn-outline-info view-app-btn">ดูใบสมัคร</button>
                                 <button class="btn btn-sm btn-outline-success approve-btn">อนุมัติ</button>
                                 <button class="btn btn-sm btn-outline-danger reject-btn">ปฏิเสธ</button>
                             </div>
                         `;
                         item.querySelector('.view-app-btn').onclick = () => this.showApplicationModal(student);
                         item.querySelector('.approve-btn').onclick = () => this.updateUserStatus(student.id, 'active');
                         item.querySelector('.reject-btn').onclick = () => deleteDoc(this.userDocRef(student.id));
                         pendingList.appendChild(item);
                     });
                 });
                 this.unsubscribeListeners.push(unsubPending);
            }

            async updateUserStatus(uid, status) {
                 await updateDoc(this.userDocRef(uid), { status });
                 alert(`User status updated to ${status}`);
            }

            showApplicationModal(student) {
                const answers = student.applicationAnswers || {};
                let answersHtml = Object.keys(answers).length > 0
                    ? Object.entries(answers).map(([q, a]) => `
                        <div class="mb-2">
                            <p class="fw-bold small text-warning mb-1">${this.escapeHtml(q)}</p>
                            <p class="p-2 rounded bg-dark">${this.escapeHtml(a)}</p>
                        </div>
                    `).join('')
                    : '<p class="text-white-50">ไม่พบข้อมูลใบสมัคร</p>';
                const footer = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                    <button type="button" class="btn btn-danger" id="modalRejectBtn">ปฏิเสธ</button>
                    <button type="button" class="btn btn-success" id="modalApproveBtn">อนุมัติ</button>
                `;
                this.showModal(`ใบสมัครของ - ${this.escapeHtml(student.name)}`, answersHtml, footer);
                document.getElementById('modalApproveBtn').onclick = () => {
                    this.updateUserStatus(student.id, 'active');
                    this.modalInstance.hide();
                };
                 document.getElementById('modalRejectBtn').onclick = () => {
                    deleteDoc(this.userDocRef(student.id));
                    this.modalInstance.hide();
                };
            }

            loadAdminManageUsers() {
                 const container = document.getElementById('all-users-container');
                 const unsubscribe = onSnapshot(this.usersCollectionRef(), (snapshot) => {
                     container.innerHTML = '';
                     this.renderUserList('Students', snapshot.docs.map(d => ({id: d.id, ...d.data()})).filter(u => u.role === 'student'), container);
                 });
                 this.unsubscribeListeners.push(unsubscribe);
            }

            renderUserList(title, userArray, container) {
                const listWrapper = document.createElement('div');
                listWrapper.className = 'mb-4';
                listWrapper.innerHTML = `<h5 class="text-warning font-mystic mt-4">${title}</h5>`;
                
                if (userArray.length === 0) { /* ... */ return; }
                
                const listGroup = document.createElement('div');
                listGroup.className = 'vstack gap-2';
                userArray.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'd-flex align-items-center justify-content-between p-2 rounded';
                    item.style.backgroundColor = 'rgba(0,0,0,0.2)';
                    item.innerHTML = `
                        <div>
                            <p class="fw-bold mb-0">${this.escapeHtml(user.name)}</p>
                            <p class="small text-white-50 mb-0">${user.house || 'ยังไม่มีสังกัด'}</p>
                        </div>
                        <button class="btn btn-sm btn-outline-warning edit-student-btn" data-uid="${user.id}">แก้ไข</button>
                    `;
                    item.querySelector('.edit-student-btn').onclick = () => this.openEditStudentModal(user);
                    listGroup.appendChild(item);
                });
                listWrapper.appendChild(listGroup);
                container.appendChild(listWrapper);
            }

            openEditStudentModal(studentData) {
                const houseOptions = Object.keys(this.constants.HOUSES)
                    .map(house => `<option value="${house}" ${studentData.house === house ? 'selected' : ''}>${house}</option>`)
                    .join('');
                const body = `
                    <form id="edit-student-form">
                        <div class="mb-3">
                            <label class="form-label">สังกัดบ้าน</label>
                            <select id="edit-student-house" class="form-select">
                                <option value="" ${!studentData.house ? 'selected' : ''}>-- ยังไม่มีสังกัด --</option>
                                ${houseOptions}
                            </select>
                        </div>
                    </form>`;
                const footer = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-warning" id="modalSaveStudentBtn">บันทึก</button>
                `;
                this.showModal(`แก้ไขข้อมูล - ${this.escapeHtml(studentData.name)}`, body, footer);

                document.getElementById('modalSaveStudentBtn').onclick = async () => {
                    const newHouse = document.getElementById('edit-student-house').value || null;
                    await updateDoc(this.userDocRef(studentData.id), { house: newHouse });
                    this.modalInstance.hide();
                };
            }

            loadAdminManageApplication() { /* ... */ }

            loadStudentDashboard() {
                const { house } = this.currentUserData;
                const theme = house ? (this.constants.HOUSES[house] || {}) : {};
                const header = document.getElementById('student-dashboard-header');
                if (header) {
                    header.style.backgroundColor = theme.primaryColor || '#374151';
                    header.querySelector('#student-house-logo').src = theme.logo || 'https://placehold.co/80x80/0c1427/e0e0e0?text=No+House';
                    header.querySelector('#student-house-name').innerText = house ? `บ้าน ${house}` : 'ยังไม่มีสังกัด';
                }
            }
        }

        window.app = new MysticUniversityApp(firebaseConfig, CONSTANTS);
    </script>
</body>
</html>
