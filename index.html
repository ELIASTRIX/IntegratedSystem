<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mystic University - ระบบจัดการแบบบูรณาการ</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

    <!-- SheetJS (xlsx) for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        :root {
            --bs-body-font-family: 'Kanit', sans-serif;
            --theme-color-primary: #8B5CF6; /* Purple from original app */
            --theme-color-secondary: #FFFFFF;
        }
        body {
            background-color: #111827; /* Dark gray from original app */
            background-image: url('img/BG.png');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            color: #FFFFFF; 
        }
        .font-main { font-family: 'Kanit', sans-serif; }
        .font-alt { font-family: 'Sarabun', sans-serif; }
        .card {
            background-color: rgba(31, 41, 55, 0.85); /* bg-gray-800/80 */
            border: 1px solid rgba(139, 92, 246, 0.3);
            backdrop-filter: blur(8px);
        }
        .btn-theme {
             background-color: var(--theme-color-primary);
             color: var(--theme-color-secondary);
             border: 1px solid var(--theme-color-primary);
        }
        .btn-theme:hover {
            opacity: 0.9;
            background-color: var(--theme-color-primary);
            color: var(--theme-color-secondary);
        }
        .btn-outline-theme {
             color: var(--theme-color-primary);
             border-color: var(--theme-color-primary);
        }
        .btn-outline-theme:hover {
            background-color: var(--theme-color-primary);
            color: var(--theme-color-secondary);
        }
        .modal-backdrop-custom {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        .nav-link.active {
            background-color: var(--theme-color-primary) !important;
            color: var(--theme-color-secondary) !important;
        }
        .nav-link:not(.active):hover { color: var(--theme-color-primary) !important; }

        .form-control, .form-select {
            background-color: #1F2937 !important; /* bg-gray-700 */
            color: #FFFFFF !important; 
            border-color: #4B5563 !important; /* border-gray-600 */
        }
        .form-control::placeholder { color: #9CA3AF !important; }
        .form-control:focus, .form-select:focus {
            border-color: var(--theme-color-primary) !important;
            box-shadow: 0 0 0 0.25rem rgba(139, 92, 246, 0.25);
        }
        .theme-text { color: var(--theme-color-primary) !important; }

        /* Loader Styles */
        .loader-full-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(17, 24, 39, 0.8);
            display: flex; align-items: center; justify-content: center; z-index: 9999;
        }
        .spinner-border-lg { width: 4rem; height: 4rem; }
    </style>
</head>
<body class="min-vh-100 font-main">

    <!-- Root container for Views -->
    <div id="root">
        <div class="loader-full-page">
             <div class="text-center">
                <div class="spinner-border text-light spinner-border-lg" role="status"></div>
                <p class="mt-3 fs-5 text-light">กำลังร่ายเวทเชื่อมต่อ...</p>
            </div>
        </div>
    </div>

    <!-- Modals (Universal) -->
    <div id="main-modal" class="modal fade" tabindex="-1" data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content card">
          <div class="modal-header border-secondary">
            <h5 class="modal-title" id="main-modal-title"></h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="main-modal-body"></div>
          <div class="modal-footer border-secondary" id="main-modal-footer"></div>
        </div>
      </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100"></div>


    <!-- ======================= -->
    <!-- HTML TEMPLATES          -->
    <!-- ======================= -->

    <template id="template-login">
        <div class="min-vh-100 d-flex align-items-center justify-content-center p-4">
            <div class="w-100" style="max-width: 450px;">
                <div class="card rounded-4 p-4 p-md-5 text-center">
                    <img src="img/MysticUniversity-Logo-NewVersion.png" alt="Mystic University Logo" class="mx-auto mb-4 rounded-circle border border-2 border-light" style="width: 120px; height: 120px;">
                    <h1 class="text-light" style="font-family: 'Sarabun', sans-serif;">Mystic University</h1>
                    <p class="text-white-50">เซิร์ฟเวอร์ Roleplay แห่งจินตนาการ</p>
                    <div class="d-grid gap-2 mt-4">
                        <button id="discord-login-btn" class="btn btn-lg btn-theme fw-bold d-flex align-items-center justify-content-center gap-2">
                            <i class="fab fa-discord"></i> เข้าสู่ระบบ / สมัครสมาชิก
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-main-layout">
        <div class="d-flex vh-100">
            <!-- Sidebar -->
            <nav id="sidebar" class="d-flex flex-column p-3" style="width: 280px; background-color: #040814;">
                <div class="text-center mb-4">
                     <h1 class="fs-4">Mystic University</h1>
                </div>
                <div id="nav-links" class="nav nav-pills flex-column mb-auto"></div>
                <div id="user-profile-summary" class="mt-auto text-center border-top border-secondary pt-3"></div>
            </nav>

            <!-- Main Content -->
            <main id="main-content-area" class="flex-grow-1 p-4 overflow-auto" style="background-color: #111827;"></main>
        </div>
    </template>
    
    <!-- Whitelist Application Template -->
    <template id="template-whitelist-apply">
         <div class="container py-5">
             <div class="row justify-content-center">
                <div class="col-lg-8">
                     <form id="whitelist-form" class="vstack gap-4 card p-4 rounded-3">
                        <div id="form-header" class="text-center border-bottom border-secondary pb-3 mb-3">
                             <h2 id="form-title" class="fs-2 fw-bold theme-text"></h2>
                             <p id="form-submission-status" class="text-warning mt-2"></p>
                        </div>
                        <div id="form-user-info" class="p-3 bg-dark rounded-3 d-flex align-items-center gap-3">
                            <img id="form-user-avatar" class="rounded-circle" width="50" height="50" alt="User Avatar"/>
                            <div>
                                <p class="fw-bold mb-0">คุณกำลังสมัครในชื่อ:</p>
                                <p id="form-user-discord-id" class="theme-text mb-0"></p>
                            </div>
                        </div>
                        <div id="dynamic-form-content" class="vstack gap-4"></div>
                        <button type="submit" class="btn btn-theme btn-lg">
                            <i class="fas fa-paper-plane me-2"></i> ส่งใบสมัคร
                        </button>
                    </form>
                </div>
             </div>
        </div>
    </template>
    
    <!-- Whitelist Status Check Template -->
    <template id="template-whitelist-status">
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card p-4 rounded-3 text-center">
                        <h2 class="fs-2 fw-bold mb-4">ตรวจสอบสถานะใบสมัคร</h2>
                        <div id="status-result"></div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Whitelist Admin Template -->
    <template id="template-admin-whitelist">
        <h2 class="text-light mb-4">จัดการใบสมัคร (Whitelist)</h2>
        <!-- Form management -->
        <div class="card p-4 mb-4">
             <h3 class="fs-5 fw-bold mb-3">จัดการฟอร์ม</h3>
             <div class="d-flex gap-2 mb-3">
                 <input type="text" id="new-form-name" placeholder="ชื่อฟอร์มใหม่" class="form-control">
                 <button id="create-form-btn" class="btn btn-primary">สร้าง</button>
             </div>
             <div class="d-flex gap-2 align-items-center">
                <select id="form-selector-admin" class="form-select"></select>
                <button id="delete-form-btn" title="ลบฟอร์ม" class="btn btn-outline-danger"><i class="fas fa-trash"></i></button>
             </div>
        </div>
        
        <div id="admin-form-controls" class="vstack gap-4 d-none">
            <!-- Form Settings -->
            <div class="card p-4">
                 <h3 class="fs-5 fw-bold mb-3">ตั้งค่าฟอร์ม</h3>
                 <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="toggle-form-btn">
                    <label class="form-check-label" for="toggle-form-btn" id="admin-form-status">ปิดรับสมัคร</label>
                  </div>
            </div>
            <!-- Questions -->
            <div class="card p-4">
                <h3 class="fs-5 fw-bold mb-3">จัดการคำถาม</h3>
                <div id="question-list" class="vstack gap-2 mb-4"></div>
                <!-- Add new question form here -->
            </div>
            <!-- Applications -->
            <div class="card p-4">
                 <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="fs-5 fw-bold mb-0">ใบสมัคร (<span id="application-count">0</span>)</h3>
                    <button id="export-applications-btn" class="btn btn-sm btn-outline-success"><i class="fas fa-file-csv me-2"></i>ส่งออก</button>
                 </div>
                 <div class="d-flex gap-2 mb-3">
                    <input type="text" id="search-applications-input" placeholder="ค้นหาด้วยชื่อ..." class="form-control">
                    <select id="filter-applications-status" class="form-select w-auto">
                        <option value="all">ทุกสถานะ</option>
                        <option value="pending">รอตรวจ</option>
                        <option value="rejected">ไม่ผ่าน</option>
                    </select>
                 </div>
                 <div id="applications-list" class="vstack gap-3"></div>
                 <div id="applications-pagination" class="d-flex justify-content-between align-items-center mt-3"></div>
            </div>
        </div>
    </template>
    
    <!-- Placeholder templates for other roles, you would create these as needed -->
    <template id="template-professor-dashboard">
        <h2 class="text-light mb-4">Professor Dashboard</h2>
        <!-- Professor content goes here -->
    </template>
     <template id="template-student-dashboard">
        <h2 class="text-light mb-4">Student Dashboard</h2>
        <!-- Student content goes here -->
    </template>

    <!-- ======================= -->
    <!-- Firebase & App Logic    -->
    <!-- ======================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, signOut, OAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, onSnapshot, collection, query, where, getDocs, deleteDoc, serverTimestamp, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Using the config from the Whitelist Application system
        const firebaseConfig = {
            apiKey: "AIzaSyDh8ngDj0hiH_JKq7VmWUEXGm_8loNidhc",
            authDomain: "mysticuwhitelist.firebaseapp.com",
            projectId: "mysticuwhitelist",
            storageBucket: "mysticuwhitelist.firebasestorage.app",
            messagingSenderId: "546334551779",
            appId: "1:546334551779:web:7a062964c715253460dfd6"
        };
        
        // --- Main App Class ---
        class IntegratedApp {
            constructor() {
                this.app = initializeApp(firebaseConfig);
                this.auth = getAuth(this.app);
                this.db = getFirestore(this.app);
                this.root = document.getElementById('root');
                this.mainModal = new bootstrap.Modal(document.getElementById('main-modal'));
                
                this.currentUser = null;
                this.currentUserData = null; // From Firestore /users
                this.currentApplication = null; // From Firestore /applications
                this.isAdmin = false;
                this.unsubscribeListeners = [];

                this.initAuthListener();
            }

            // --- 1. AUTHENTICATION & INITIALIZATION ---
            initAuthListener() {
                onAuthStateChanged(this.auth, async (user) => {
                    this.cleanupListeners();
                    this.root.innerHTML = `<div class="loader-full-page"><div class="spinner-border text-light spinner-border-lg" role="status"></div></div>`;
                    
                    if (user) {
                        this.currentUser = user;
                        // 1. Check for an active user profile in /users
                        const userRef = doc(this.db, 'users', user.uid);
                        const userSnap = await getDoc(userRef);

                        if (userSnap.exists() && userSnap.data().status === 'active') {
                            this.currentUserData = { uid: user.uid, ...userSnap.data() };
                            this.isAdmin = this.currentUserData.role === 'admin';
                            this.renderView('main-layout');
                        } else {
                             // 2. If no active user, check for an existing application in /applications
                             const appQuery = query(collection(this.db, 'applications'), where("uid", "==", user.uid), orderBy("submittedAt", "desc"));
                             const appSnap = await getDocs(appQuery);

                             if (!appSnap.empty) {
                                this.currentApplication = { id: appSnap.docs[0].id, ...appSnap.docs[0].data() };
                                this.renderView('whitelist-status');
                             } else {
                                // 3. If nothing found, they are a new user, show application form.
                                this.renderView('whitelist-apply');
                             }
                        }
                    } else {
                        // Not logged in
                        this.currentUser = null;
                        this.currentUserData = null;
                        this.isAdmin = false;
                        this.renderView('login');
                    }
                });
            }

            handleDiscordLogin() {
                const provider = new OAuthProvider('oidc.discord');
                signInWithPopup(this.auth, provider).catch(error => {
                    console.error("Discord Login Error:", error);
                    this.showToast(`เกิดข้อผิดพลาดในการล็อกอิน: ${error.code}`, true);
                });
            }
            
            handleLogout() {
                 signOut(this.auth);
            }
            
            // --- 2. VIEW & UI RENDERING ---
            renderView(viewName) {
                this.cleanupListeners(); // Clear old listeners before rendering new view
                const template = document.getElementById(`template-${viewName}`);
                if (template) {
                    this.root.innerHTML = '';
                    this.root.appendChild(template.content.cloneNode(true));
                    this.setupView(viewName);
                } else {
                    this.root.innerHTML = `<p class="text-danger p-5 text-center">Error: View "${viewName}" not found.</p>`;
                }
            }
            
            setupView(viewName) {
                switch(viewName) {
                    case 'login':
                        document.getElementById('discord-login-btn').addEventListener('click', () => this.handleDiscordLogin());
                        break;
                    case 'main-layout':
                        this.setupMainLayout();
                        break;
                    case 'whitelist-status':
                        this.renderApplicationStatus();
                        break;
                    case 'whitelist-apply':
                        this.renderApplicationForm();
                        break;
                }
            }
            
            setupMainLayout() {
                // Render profile summary in sidebar
                const profileContainer = document.getElementById('user-profile-summary');
                if (profileContainer && this.currentUserData) {
                    profileContainer.innerHTML = `
                        <img src="${this.currentUser.photoURL || 'https://placehold.co/80x80/040814/e0e0e0?text=User'}" alt="Profile Picture" class="rounded-circle mb-2" width="60" height="60">
                        <p class="fw-bold mb-0">${this.currentUserData.name}</p>
                        <p class="small theme-text">${this.currentUserData.role}</p>
                        <button id="logout-btn" class="btn btn-sm btn-outline-danger w-100 mt-2">ออกจากระบบ</button>
                    `;
                    profileContainer.querySelector('#logout-btn').addEventListener('click', () => this.handleLogout());
                }

                // Render nav links based on role
                const navContainer = document.getElementById('nav-links');
                navContainer.innerHTML = '';
                let links = [];

                if (this.isAdmin) {
                    links.push({ name: 'จัดการใบสมัคร', page: 'admin-whitelist', icon: 'fa-solid fa-file-signature' });
                    // Add other admin links from System 2 here
                }
                
                // Add other roles (professor, student) from System 2 here
                
                links.forEach((link, index) => {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.className = 'nav-link text-light d-flex align-items-center gap-2';
                    a.dataset.page = link.page;
                    a.innerHTML = `<i class="${link.icon} fa-fw"></i><span>${link.name}</span>`;
                    navContainer.appendChild(a);
                    if (index === 0) {
                        a.classList.add('active');
                        this.loadPageContent(link.page);
                    }
                });

                navContainer.addEventListener('click', (e) => {
                    e.preventDefault();
                    const link = e.target.closest('.nav-link');
                    if (link) {
                        navContainer.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        this.loadPageContent(link.dataset.page);
                    }
                });
            }
            
            loadPageContent(pageName) {
                const container = document.getElementById('main-content-area');
                const template = document.getElementById(`template-${pageName}`);
                if (container && template) {
                    container.innerHTML = '';
                    container.appendChild(template.content.cloneNode(true));
                    
                    // Call the setup function for the specific admin page
                    if (pageName === 'admin-whitelist') {
                        this.setupAdminWhitelistPage();
                    }
                    // Add other page loaders here
                }
            }

            // --- 3. WHITELIST APPLICATION & STATUS LOGIC ---

            async renderApplicationForm() {
                const formList = await getDocs(query(collection(this.db, "forms"), where("isOpen", "==", true)));
                if (formList.empty) {
                    this.root.innerHTML = '<div class="vh-100 d-flex align-items-center justify-content-center"><div class="card p-5 text-center"><h2 class="text-danger">ปิดรับสมัคร</h2><p class="text-white-50">ขณะนี้ยังไม่มีการเปิดรับสมัคร</p></div></div>';
                    return;
                }
                // For simplicity, we use the first open form.
                const formDoc = formList.docs[0];
                const formId = formDoc.id;
                const formData = formDoc.data();
                
                document.getElementById('whitelist-form').dataset.formId = formId;
                document.getElementById('form-title').textContent = formData.name;
                document.getElementById('form-user-avatar').src = this.currentUser.photoURL;
                document.getElementById('form-user-discord-id').textContent = this.currentUser.displayName;
                
                const qContainer = document.getElementById('dynamic-form-content');
                qContainer.innerHTML = '';
                const questionsSnap = await getDocs(query(collection(this.db, 'forms', formId, 'questions'), orderBy("createdAt")));
                
                questionsSnap.forEach(doc => {
                    const qData = { id: doc.id, ...doc.data() };
                    // Logic to render each question type (text, textarea, etc.)
                    // This needs to be adapted from the original whitelist app's JS
                    // For brevity, this is simplified. A full implementation would be here.
                    const div = document.createElement('div');
                    div.innerHTML = `<label for="${qData.id}" class="form-label">${qData.label} ${qData.required ? '<span class="text-danger">*</span>' : ''}</label>
                                     <input type="text" id="${qData.id}" name="${qData.label}" class="form-control" ${qData.required ? 'required' : ''}>`;
                    qContainer.appendChild(div);
                });

                document.getElementById('whitelist-form').addEventListener('submit', (e) => this.handleApplicationSubmit(e));
            }

            async handleApplicationSubmit(event) {
                 event.preventDefault();
                 const form = event.target;
                 const formId = form.dataset.formId;
                 const formData = new FormData(form);
                 const answers = Object.fromEntries(formData.entries());
                 
                 await addDoc(collection(this.db, 'applications'), {
                    uid: this.currentUser.uid,
                    discordId: this.currentUser.displayName,
                    discordAvatar: this.currentUser.photoURL,
                    formId: formId,
                    answers: answers,
                    status: 'pending',
                    submittedAt: serverTimestamp()
                 });

                 this.showToast('ส่งใบสมัครสำเร็จแล้ว!');
                 this.initAuthListener(); // Re-check auth state to show status page
            }
            
            renderApplicationStatus() {
                const container = document.getElementById('status-result');
                if (!container || !this.currentApplication) return;
                
                const app = this.currentApplication;
                let statusText, statusColor, icon;

                switch (app.status) {
                    case 'approved': 
                        statusText = "ผ่านการคัดเลือก"; statusColor = "text-success"; icon = "fa-check-circle";
                        // This is where the user would be fully created in the /users collection
                        // For now, it just shows a message.
                        break;
                    case 'rejected': 
                        statusText = "ไม่ผ่านการคัดเลือก"; statusColor = "text-danger"; icon = "fa-times-circle"; 
                        break;
                    default: 
                        statusText = "รอการตรวจสอบ"; statusColor = "text-warning"; icon = "fa-hourglass-half";
                }
                
                container.innerHTML = `
                    <h3 class="fw-bold ${statusColor}"><i class="fas ${icon} me-2"></i>สถานะ: ${statusText}</h3>
                    ${app.adminComment ? `<div class="mt-4 p-3 bg-dark rounded-3"><p class="fw-bold">ความเห็นจากแอดมิน:</p><p class="text-white-50">${app.adminComment}</p></div>` : ''}
                    <button id="logout-btn-status" class="btn btn-outline-secondary mt-4">ออกจากระบบ</button>
                `;
                 container.querySelector('#logout-btn-status').addEventListener('click', () => this.handleLogout());
            }

            // --- 4. ADMIN WHITELIST MANAGEMENT ---
            
            setupAdminWhitelistPage() {
                // Initial setup for the admin page
                const createBtn = document.getElementById('create-form-btn');
                const deleteBtn = document.getElementById('delete-form-btn');
                const formSelector = document.getElementById('form-selector-admin');
                const searchInput = document.getElementById('search-applications-input');
                const filterSelect = document.getElementById('filter-applications-status');

                // Load forms into selector
                const qForms = query(collection(this.db, "forms"), orderBy("createdAt", "desc"));
                const unsubForms = onSnapshot(qForms, (snapshot) => {
                    formSelector.innerHTML = '<option value="">-- เลือกฟอร์ม --</option>';
                    snapshot.forEach(doc => {
                        formSelector.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`;
                    });
                });
                this.unsubscribeListeners.push(unsubForms);

                // Event Listeners
                formSelector.addEventListener('change', () => {
                    const formId = formSelector.value;
                    document.getElementById('admin-form-controls').classList.toggle('d-none', !formId);
                    if (formId) {
                        this.listenToFormApplications(formId);
                    }
                });

                createBtn.addEventListener('click', async () => {
                    const nameInput = document.getElementById('new-form-name');
                    if (nameInput.value) {
                        await addDoc(collection(this.db, "forms"), {
                            name: nameInput.value,
                            isOpen: false,
                            createdAt: serverTimestamp()
                        });
                        nameInput.value = '';
                        this.showToast('สร้างฟอร์มสำเร็จ');
                    }
                });
                
                // Add more logic for other buttons and filtering...
            }

            listenToFormApplications(formId) {
                // Cleanup previous application listener
                const oldUnsub = this.unsubscribeListeners.find(u => u.id === 'apps');
                if(oldUnsub) oldUnsub();

                const q = query(collection(this.db, 'applications'), where("formId", "==", formId));
                const unsub = onSnapshot(q, (snapshot) => {
                    const apps = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    // Store and render application list with pagination, etc.
                    this.renderApplicationList(apps);
                });
                unsub.id = 'apps'; // Tag listener for easy removal
                this.unsubscribeListeners.push(unsub);
            }
            
            renderApplicationList(apps) {
                 const container = document.getElementById('applications-list');
                 container.innerHTML = '';
                 // This would contain the pagination and rendering logic from the original app
                 if (apps.length === 0) {
                     container.innerHTML = '<p class="text-white-50">ไม่มีใบสมัครสำหรับฟอร์มนี้</p>';
                     return;
                 }
                 apps.forEach(app => {
                     const div = document.createElement('div');
                     div.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                     div.innerHTML = `<span>${app.discordId} (${app.status})</span> <button class="btn btn-sm btn-outline-info">ตรวจสอบ</button>`;
                     // Add click handler to open review modal
                     container.appendChild(div);
                 });
            }

            // --- UTILITY FUNCTIONS ---
            showToast(message, isError = false) {
                const container = document.querySelector('.toast-container');
                const toastEl = document.createElement('div');
                toastEl.className = `toast align-items-center text-white ${isError ? 'bg-danger' : 'bg-success'} border-0`;
                toastEl.setAttribute('role', 'alert');
                toastEl.setAttribute('aria-live', 'assertive');
                toastEl.setAttribute('aria-atomic', 'true');
                toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
                container.appendChild(toastEl);
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
            }

            cleanupListeners() {
                this.unsubscribeListeners.forEach(unsub => typeof unsub === 'function' && unsub());
                this.unsubscribeListeners = [];
            }
        }

        // --- App Instantiation ---
        window.mysticApp = new IntegratedApp();
    </script>
</body>
</html>
